from contextlib import contextmanager
import os
import tempfile

# Test configuration options for regression tests
default_config = {
    'exe': 'adder',
    'plot': False,
    'update': False,
    'build_inputs': False,
    'origen_exe': 'origen2.EXE',
    'mcnp_exe': 'mcnp.EXE',
    'extract_exe': 'adder_extract_materials.py'
}


@contextmanager
def cdtemp():
    """Context manager to change to/return from a tmpdir."""
    with tempfile.TemporaryDirectory() as tmpdir:
        cwd = os.getcwd()
        try:
            os.chdir(tmpdir)
            yield
        finally:
            os.chdir(cwd)


mcnp_2x2x2 = """Simple 2x2x2 Grid
c
c Now define each of these 4 universes
12 12 -1.2 10.0 -11 21 -22 31 -32 u=0 imp:n,p 1 $ Upper top left
11 11 -1.1 10 -11 21 -22 30 -31 u=0 imp:n,p=1 $ Lower top left
c
21 21 -2.1 11 -12 21 -22 30 -31 imp:n,p=1 u=0 $ Lower top right
22 22 -2.2 11 -12 21 -22 31 -32 imp:n,p 1 u=0 $ Upper top right
c
31 31  3.1 10 -11 20 -21 30 -31 u=0 imp:n,p=1 $ Lower bottom left
32 32 -3.2 10 -11 20 -21 31 -32 u=0 imp:n,p=1 $ Upper bottom left
c
41 41 -4.1 11 -12 20 -21 30 -31 u=0 imp:n,p=1 $ Lower bottom right
42 42 -4.2 11 -12 20 -21 31 -32 u=0 imp:n,p=1 $ Upper bottom right
c
c Define the model periphery
99 0 -10 12 -20 22 -30 32 imp:n,p=0 $ Exterior
""" + "   \n" + \
"""c Surface Definitions
c
c 10 series will be x-plane
c 20 will be y-plane
c 30 will be z-plane
*10 px  0.0
11  px 10.0
*12 px 20.0
*20 py  0.0
21  py 10.0
*22 py 20.0
*30 pz  0.0
31  pz 10.0
*32 pz 20.0

c
c Define Materials
c
m0 nlib=70c
m11  92235.70c  1-1 92238.70c  0.1 8016.70c  0.8
c The following weight percents were chosen to yield U235 0.1, U238 0.2, O16 0.7
m12  92235.70c -0.285555944474272
     92238.70c -0.578417982008341
     8016.70c -0.136026073517386 nlib=70c
m21  92235.70c  0.2 92238.70c  0.1 8016.70c  0.7 nlib=70c
m22  92235.70c  0.2 92238.70c  0.2 8016.70c  0.6 nlib=70c
m31  92235.70c  0.3 92238.70c  0.1 8016.70c  0.6 nlib=70c
m32  92235.70c  0.3 92238.70c  0.2 8016.70c  0.5 nlib=70c
m41  92235.70c  0.4 92238.70c  0.1 8016.70c  0.5 nlib=70c
m42  92235.70c  0.4 92238.70c  0.2 8016.70c  0.4 nlib=70c
m51  92235.70c  0.5 92238  0.1 8016.70c  0.3 1001.70c 0.1 nlib=70c
m61  92235.70c  0.6 92238.70u  0.1 8016.70c  0.3 nlib=70c
m62  92235.70c  0.6 92238.70c  0.2 8016.70c  0.2 nlib=70c
c
c Define volumes
c
vol 1000.0 7R 0.0
c
c Set run parameters
c
kcode 1E2 1.0 10 100
prdmp 3j
sdef  x=d1 y=d2 z=d3 erg=2
si1 0 20
sp1 0 1
si2 0 20
sp2 0 1
si3 0 20
sp3 0 1
FMESH4:n ORIGIN=0,0,0 IMESH=10,20 JMESH=10,20 KMESH=10,20
"""

mcnp_2x2x2_trcl = """Simple 2x2x2 Grid, but the title is artificially long to make sure it is trimmed by ADDER
c
c Define cells
11 11 -1.1 10 -11 21 -22 30 -31 u=0 trcl=1 imp:n=1 $ Lower top left
12 12 -1.2 10 -11 21 -22 31 -32 u=0 trcl=2 imp:n=1 $ Upper top left
c
21 21 -2.1 11 -12 21 -22 30 -31 u=0
     trcl=(0 0 0 0 0 -1 0 1 0 1  0 0) imp:n=1 $ Lower top right
22 22 -2.2 &
 11 -12 21 -22 31 -32 u=0 trcl=0 imp:n=1 $ Upper top right
c
31 31  3.1 10 -11 20 -21 30 -31 u=0 trcl=3 imp:n=1 $ Lower bottom left
32 32 -3.2 10 -11 20 -21 31 -32 u=0 *trcl=(0 0 0 45 -45 90 135 45 90 90 90 0) imp:n=1 $ Upper bottom left
c
41 41 -4.1 11 -12 20 -21 30 -31 u=0 trcl=4 imp:n=1 $ Lower bottom right
42 42 -4.2 11 -12 20 -21 31 -32 u=0 trcl=5 imp:n=1 $ Upper bottom right
c
c Define the model periphery
99 0 -10 12 -20 22 -30 32 imp:n=0 $ Exterior

c Surface Definitions
c
c 10 series will be x-plane
c 20 will be y-plane
c 30 will be z-plane
*10 px  0.0
11  px 10.0
*12 px 20.0
*20 py  0.0
21  py 10.0
*22 py 20.0
*30 pz  0.0
31  pz 10.0
*32 pz 20.0

c
c Define Materials
c
m0 nlib=70c
m11  92235.70c  0.1 92238.70c  0.1 8016.70c  0.8
c The following weight percents were chosen to yield U235 0.1, U238 0.2, O16 0.7
m12  92235.70c -0.285555944474272
     92238.70c -0.578417982008341
     8016.70c -0.136026073517386 nlib=70c
m21  92235.70c  0.2 92238.70c  0.1 8016.70c  0.7 nlib=70c
m22  92235.70c  0.2 92238.70c  0.2 8016.70c  0.6 nlib=70c
m31  92235.70c  0.3 92238.70c  0.1 8016.70c  0.6 nlib=70c
m32  92235.70c  0.3 92238.70c  0.2 8016.70c  0.5 nlib=70c
m41  92235.70c  0.4 92238.70c  0.1 8016.70c  0.5 nlib=70c
m42  92235.70c  0.4 92238.70c  0.2 8016.70c  0.4 nlib=70c
m51  92235.70c  0.5 92238  0.1 8016.70c  0.3 1001.70c 0.1 nlib=70c
m61  92235.70c  0.6 92238.70u  0.1 8016.70c  0.3 nlib=70c
m62  92235.70c  0.6 92238.70c  0.2 8016.70c  0.2 nlib=70c
c
c Define coordinate transforms
c tr1: 90 deg about x, with explicit m
tr1 0 0 0 1 0  0 0 0 1 0 -1 0 1
c tr2: 90 deg about y, w/o m
tr2 0 0 0 0 0 -1 0 1 0 1  0 0
c tr3: same as tr2 but in deg
*tr3 0 0 0 45 -45 90 135 45 90 90 90 0
c tr4 and tr5 are intended to be the same with differing patterns
*tr4 0 0 0 0 90 90 90 30 60 90 120 30
*tr5 0 0 0 3J 90 30 60
c
c Define volumes
c
vol 1000.0 7R 0.0
c
c Set run parameters
c
kcode 100 1.0 10 100
sdef  x=d1 y=d2 z=d3 erg=2
si1 0 20
sp1 0 1
si2 0 20
sp2 0 1
si3 0 20
sp3 0 1
FMESH4:n ORIGIN=0,0,0 IMESH=10,20 JMESH=10,20 KMESH=10,20 TYPE=FLUX
"""


mcnp_lattice = """simple lattice
1 0 -1 fill 10 (0 0 0 1 0  0 0 0 1 0 -1 0 1) imp:n 1
2 10 1.0 -301 302 -303 304 lat=1 u=10 imp:n=1
     fill -2:2 -2:2 0:0
     10 10 10 10 10
     10  1  2(1)  3 10
     10  2(2)  5  6 10
     10  7  8  9 10
     10 10 10 10 10
11 1 2.0 -10 u=1 imp:n=1 vol=0.528101
21 2 2.0 -10 u=2 imp:n=1 vol=0.528101
31 3 2.0 -10 u=3 imp:n=1 vol=0.528101
41 4 2.0 -10 u=4 imp:n=1 vol=0.528101
51 5 2.0 -10 u=5 imp:n=1 vol=0.528101
61 6 2.0 -10 u=6 imp:n=1 vol=0.528101
71 7 2.0 -10 u=7 imp:n=1 vol=0.528101
81 8 2.0 -10 u=8 imp:n=1 vol=0.528101
91 like 81 but mat=9 u=9
95 like 11 but u=11 mat=11 rho=2.0
97 13 2.0 -10 u=12 imp:n=1 vol=0.528101
10 10 1.0 +10 u=1 imp:n=1 vol=1.059498275
20 like 10 but u=2
30 10 1.0 +10 u=3 imp:n=1 vol=1.059498275
40 10 1.0 +10 u=4 imp:n=1 vol=1.059498275
50 10 1.0 +10 u=5 imp:n=1 vol=1.059498275
60 10 1.0 +10 u=6 imp:n=1 vol=1.059498275
70 10 1.0 +10 u=7 imp:n=1 vol=1.059498275
80 10 1.0 +10 u=8 imp:n=1 vol=1.059498275
90 10 1.0 +10 u=9 imp:n=1 vol=1.059498275
96 12 1.0 +10 u=11 imp:n=1 vol=1.059498275
98 14 1.0 +10 u=12 imp:n=1 vol=1.059498275
5 0 1 imp:n=0

1 cz 3.15
10 cz 0.41
301 px .63
302 px -.63
303 py .63
304 py -.63

m0 nlib=72c
m1 92235 5.0 92238.70c 95. 8016.70c 100. nlib=71c
m2 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m3 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m4 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m5 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m6 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m7 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m8 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m9 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m10 1001.70c 2. 8016 1. nlib=72c
m11 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m12 1001.70c 2. 8016 1. nlib=72c
mt12 lwtr.10t
m13 92235.70c 5.0 92238.70c 95. 8016.70c 100.
m14 1001.70c 2. 8016 1. nlib=72c
mt14 lwtr.10t
c
c Define coordinate transforms
c tr1: 90 deg about x, with explicit m
tr1 0 0 0 1 0  0 0 0 1 0 -1 0 1
c tr2: 90 deg about y, w/o m
tr2 0 0 0 0 0 -1 0 1 0 1  0 0
c
kcode 100 1.0 10 100
ksrc -.63 -.63 0. -.63 0. 0. -.63 .63 0.
       0. -.63 0.   0. 0. 0.   0. .63 0.
      .63 -.63 0.  .63 0. 0.  .63 .63 0.
mode n
DBCN 1
f4:n 11 21 31 41 51 61 71 81 91
e4 1. 20.
fc4 testing
f14:n 11
m15 92235.70c 1.0
fm14 (1. 15 (-1 103))
"""

mcnp_plate_lattice = """Plate Lattice
101 0 -503 502 -403 402 -600 605 fill=1000 imp:n=1
c
102 0 -401 400 -501 500 -600 605 u=1000 lat=1 imp:n=1
                         fill=-2:2 0:0 0:0 1001 4r 
c
200 1 -1.0 #201 #202 #203 #204 #205 u=1001 imp:n=1
201 0 -405 404 -505 504 -600 601 u=1001 fill=1011 imp:n=1
202 0 -405 404 -505 504 -601 602 u=1001 fill=1012 imp:n=1
203 0 -405 404 -505 504 -602 603 u=1001 fill=1013 imp:n=1
204 0 -405 404 -505 504 -603 604 u=1001 fill=1014 imp:n=1
205 0 -405 404 -505 504 -604 605 u=1001 fill=1015 imp:n=1
c
301 2 -17.2 -405 404 -507 506 u=1011 imp:n=1
                   lat=1 fill=0:0 -1:1 0:0 1011 2r
302 2 -17.2 -405 404 -507 506 u=1012 imp:n=1
                   lat=1 fill=0:0 -1:1 0:0 1012 2r
303 3 -17.2 -405 404 -507 506 u=1013 imp:n=1
                   lat=1 fill=0:0 -1:1 0:0 1013 2r
304 3 -17.2 -405 404 -507 506 u=1014 imp:n=1
                   lat=1 fill=0:0 -1:1 0:0 1014 2r
305 3 -17.2 -405 404 -507 506 u=1015 imp:n=1
                   lat=1 fill=0:0 -1:1 0:0 1015 2r
999 0 503:-502:403:-402:600:-605 imp:n=0
                   
c Surfaces
400 px -0.2
401 px  0.2
402 px -1
403 px  1
404 px -.01
405 px  .01
c
500 py -3.5
501 py  3.5
502 py -3.25
503 py  3.25
504 py -3
505 py  3
506 py -1
507 py  1
c 
600 pz 10
601 pz 8
602 pz 6
603 pz 5
604 pz 3
605 pz 0

c Data cards
m0 nlib=70c
m1 1001 0.66667 8016 0.33333
m2 92235 -0.2 92238 -0.8
m3 92235 -0.2 92238 -0.8
kcode 1000 1.0 25 100
ksrc 0 0 5
"""

xsdir = """
atomic weight ratios
   0001  1.000000   0001  1.000000
   1000  0.99931697 1001   0.99916733   1002   1.99679968   1003   2.99013997
                    1004   3.99320563   1005   4.99205575   1006   5.99301364
                    1007   6.99216250
   8000  15.8618629 8012   11.93102358  8013   12.91292282  8014   13.88825568
                    8015   14.87418208  8016   15.85751063  8017   16.85310100
                    8018   17.84453957  8019   18.84033026  8020   19.83223212
                    8021   20.82818145  8022   21.82089077  8023   22.81797186
                    8024   23.81412553  8025   24.81444493  8026   25.81465816
                    8027   26.81590246  8028   27.81677995
  53000  125.814297 53108  107.01618874 53109  108.00231843 53110  108.99084551
                    53111  109.97733169 53112  110.96645502 53113  111.95357231
                    53114  112.94320663 53115  113.93084681 53116  114.92102761
                    53117  115.90930563 53118  116.90014410 53119  117.88857939
                    53120  118.87996331 53121  119.86871450 53122  120.86034458
                    53123  121.84977097 53124  122.84179604 53125  123.83163944
                    53126  124.82403441 53127  125.81430235 53128  126.80703715
                    53129  127.79763201 53130  128.79071357 53131  129.78157817
                    53132  130.77484437 53133  131.76605517 53134  132.75939549
                    53135  133.75110606 53136  134.74708188 53137  135.74168062
                    53138  136.73753041 53139  137.73265761 53140  138.72892555
                    53141  139.72433045 53142  140.72084573 53143  141.71659762
                    53144  142.71339050
  54000  130.165210 54110  108.99980395 54111  109.98856039 54112  110.97404239
                    54113  111.96318957 54114  112.94928427 54115  113.93902190
                    54116  114.92575907 54117  115.91595674 54118  116.90322209
                    54119  117.89387024 54120  118.88168447 54121  119.87277434
                    54122  120.86111624 54123  121.85263906 54124  122.84148191
                    54125  123.83338958 54126  124.82269550 54127  125.81500729
                    54128  126.80477855 54129  127.79742551 54130  128.78757453
                    54131  129.78054488 54132  130.77103347 54133  131.76418516
                    54134  132.75508286 54135  133.74830966 54136  134.73971056
                    54137  135.73542609 54138  136.72920741 54139  137.72541383
                    54140  138.71964689 54141  139.71602050 54142  140.71046526
                    54143  141.70722880 54144  142.70200912 54145  143.69893087
                    54146  144.69398878 54147  145.69115839
  92000  235.984128 92217  215.16002530 92218  216.15060886 92219  217.14338998
                    92220  218.13460503 92221  219.12767615 92222  220.11877536
                    92223  221.11182328 92224  222.10310013 92225  223.09628025
                    92226  224.08763820 92227  225.08084977 92228  226.07247506
                    92229  227.06599820 92230  228.05783784 92231  229.05158105
                    92232  230.04384561 92233  231.03771289 92234  232.03042798
                    92235  233.02478975 92236  234.01782329 92237  235.01236782
                    92238  236.00581772 92239  237.00070218 92240  237.99439065
                    92241  238.98950607 92242  239.98349424
03/04/2013
directory
92238.70c 236.005800 92238.70c  0 1 1 60  0 0 2.5301e-08
92238.71c 236.005800 92238.71c  0 1 1 60  0 0 2.5301e-08
92238.72c 236.005800 92238.72c  0 1 1 60  0 0 2.5301e-08
# This comment should not break the code
92235.70c 233.024800 92235.70c  0 1 1 60  0 0 2.5301e-08
92235.71c 233.024800 92235.71c  0 1 1 60  0 0 2.5301e-08
92235.72c 233.024800 92235.72c  0 1 1 60  0 0 2.5301e-08
54135.70c 133.748000 54135.70c  0 1 1 16  0 0 2.5301e-08
54135.71c 133.748000 54135.71c  0 1 1 16  0 0 2.5301e-08
54135.72c 133.748000 54135.72c  0 1 1 16  0 0 2.5301e-08
53135.70c 133.750000 53135.70c  0 1 1 16  0 0 2.5301e-08
53135.71c 133.750000 53135.71c  0 1 1 16  0 0 2.5301e-08
53135.72c 133.750000 53135.72c  0 1 1 16  0 0 2.5301e-08
8016.70c 15.857510 8016.70c   0 1 1 16  0 0 2.5301e-08
8016.71c 15.857510 8016.71c   0 1 1 16  0 0 2.5301e-08
8016.72c 15.857510 8016.72c   0 1 1 16  0 0 2.5301e-08
1001.70c 0.999167 1001.70c   0 1 1 16  0 0 2.5301e-08
1001.71c 0.999167 1001.71c   0 1 1 16  0 0 2.5301e-08
1001.72c 0.999167 1001.72c   0 1 1 16  0 0 2.5301e-08
"""

# One xs file for each of 92238, 92235, 54135, 53135, 8016, 1001 at
# 70c, 71c, and 72c; the printing code will replace the .70c with
# the values needed when we get there
xs_file_names = ["92238.{}", "92235.{}", "54135.{}", "53135.{}",
                 "8016.{}", "1001.{}"]
xs_file_ext = ["70c", "71c", "72c"]
xs_files = [
""" 92238.{}  236.005800 2.53010e-08 2020-05-24
ACE file created by simple_ace.pl                                     2020-05-24
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
       60    92238        2        1        1        0        0        0
        0        0        0        0        0        0        0        0
        1       11       18       19       20       21       22       26
       28       38       39        0        0        0        0        0
        0        0        0        0       57       60        0        0
        0        0        0        0        0        0        0        0
               1e-11                 100                  20                  60
                  10                  10                  10                  10
                   0                   0                   2                   0
                   2               1e-11                 100                 2.4
                 2.4                  18                   0                  19
                   1                   1                   2                   0
                  40                   1                   6                   2
               1e-11                 100                   0                   0
                   2               1e-11                 100                   0
                   0                   1                   0                   1
                  10                   0                   2               1e-11
                 100                   1                   1                   0
                   2               1e-11                 100                   2
            1.999998            2.000002            1.999998            2.000002
                   1                   2                   0                  40
""",
""" 92235.{}  233.024800 2.53010e-08 2020-05-24
ACE file created by simple_ace.pl                                     2020-05-24
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
       60    92235        2        1        1        0        0        0
        0        0        0        0        0        0        0        0
        1       11       18       19       20       21       22       26
       28       38       39        0        0        0        0        0
        0        0        0        0       57       60        0        0
        0        0        0        0        0        0        0        0
               1e-11                 100                  60                  60
                  10                  10                  10                  10
                   0                   0                   2                   0
                   2               1e-11                 100                 2.4
                 2.4                  18                   0                  19
                   1                   1                   2                  40
                  40                   1                   6                   2
               1e-11                 100                   0                   0
                   2               1e-11                 100                   0
                   0                   1                   0                   1
                  10                   0                   2               1e-11
                 100                   1                   1                   0
                   2               1e-11                 100                   2
            1.999998            2.000002            1.999998            2.000002
                   1                   2                  40                  40
""",
""" 54135.{}  133.748000 2.53010e-08 2020-05-24
ACE file created by simple_ace.pl                                     2020-05-24
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
       16    54135        2        0        0        0        0        0
        0        0        0        0        0        0        0        0
        1        0        0        0        0        0        0       11
       12        0        0        0        0        0        0        0
        0        0        0        0        0       16        0        0
        0        0        0        0        0        0        0        0
               1e-11                 100               10010               10010
               10000               10000                  10                  10
                   0                   0                   1                   2
               1e-11                 100                   0                   0
""",
""" 53135.{}  133.750000 2.53010e-08 2020-05-24
ACE file created by simple_ace.pl                                     2020-05-24
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
       16    53135        2        0        0        0        0        0
        0        0        0        0        0        0        0        0
        1        0        0        0        0        0        0       11
       12        0        0        0        0        0        0        0
        0        0        0        0        0       16        0        0
        0        0        0        0        0        0        0        0
               1e-11                 100                  20                  20
                  10                  10                  10                  10
                   0                   0                   1                   2
               1e-11                 100                   0                   0
""",
"""  8016.{}   15.857510 2.53010e-08 2020-05-24
ACE file created by simple_ace.pl                                     2020-05-24
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
       16     8016        2        0        0        0        0        0
        0        0        0        0        0        0        0        0
        1        0        0        0        0        0        0       11
       12        0        0        0        0        0        0        0
        0        0        0        0        0       16        0        0
        0        0        0        0        0        0        0        0
               1e-11                 100                  11                  11
                   1                   1                  10                  10
                   0                   0                   1                   2
               1e-11                 100                   0                   0
""",
"""  1001.{}    0.999167 2.53010e-08 2020-05-24
ACE file created by simple_ace.pl                                     2020-05-24
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
      0   0.000000      0   0.000000      0   0.000000      0   0.000000
       16     1001        2        0        0        0        0        0
        0        0        0        0        0        0        0        0
        1        0        0        0        0        0        0       11
       12        0        0        0        0        0        0        0
        0        0        0        0        0       16        0        0
        0        0        0        0        0        0        0        0
               1e-11                 100                 110                 110
                  10                  10                 100                 100
                   0                   0                   1                   2
               1e-11                 100                   0                   0
"""]
